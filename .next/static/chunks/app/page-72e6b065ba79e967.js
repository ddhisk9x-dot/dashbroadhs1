(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1389:(e,t,s)=>{Promise.resolve().then(s.bind(s,3955))},3955:(e,t,s)=>{"use strict";s.d(t,{default:()=>ec});var n=s(5155),a=s(2115);async function l(e,t){let s=await fetch(e,{credentials:"include",headers:{"Content-Type":"application/json",...(null==t?void 0:t.headers)||{}},...t});if(!s.ok)throw Error(await s.text().catch(()=>"")||"HTTP ".concat(s.status));return await s.json()}let r={async login(e,t){try{let s=await l("/api/login",{method:"POST",body:JSON.stringify({username:e,password:t})});if(!s.ok)return{success:!1,error:s.error||"Đăng nhập thất bại"};return{success:!0,user:s.user}}catch(e){return{success:!1,error:(null==e?void 0:e.message)||"Lỗi kết nối server"}}},async logout(){await l("/api/logout",{method:"POST"})},getAllStudents:async()=>(await l("/api/admin/get-students")).students||[],getStudentMe:async e=>(await l("/api/student/me")).student,importExcel:async e=>(await l("/api/admin/save-students",{method:"POST",body:JSON.stringify({students:e})}),{success:!0}),saveReport:async(e,t,s,n)=>(await l("/api/admin/save-report",{method:"POST",body:JSON.stringify({mhs:e,report:t,actions:s,monthKey:n})}),{success:!0}),async tick(e,t,s,n){let a="",r="",i=!1;return"boolean"==typeof n?(a=String(null!=t?t:"").trim(),r=String(null!=s?s:"").trim(),i=!!n):(a=String(null!=e?e:"").trim(),r=String(null!=t?t:"").trim(),i=!!s),{success:!0,student:(await l("/api/student/tick",{method:"POST",body:JSON.stringify({actionId:a,date:r,completed:i})})).student}},generateStudentReport:async e=>l("/api/ai/generate-report",{method:"POST",body:JSON.stringify({student:e})}),syncSheet:async e=>l("/api/sync/sheets",{method:"POST",body:JSON.stringify(e||{mode:"new_only"})})},i=r.generateStudentReport;var o=s(5299);function d(){let[e,t]=(0,a.useState)(""),[s,l]=(0,a.useState)(""),[r,i]=(0,a.useState)(""),[d,c]=(0,a.useState)(!1),x=async()=>{if(!e||!s)return alert("Nhập đủ mật khẩu hiện tại + mật khẩu mới");if(s!==r)return alert("Mật khẩu mới nhập lại kh\xf4ng khớp");c(!0);try{let n=await fetch("/api/account/change-password",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({currentPassword:e,newPassword:s})}),a=await n.json().catch(()=>({}));if(!n.ok||!(null==a?void 0:a.ok))return alert((null==a?void 0:a.error)||"Đổi mật khẩu thất bại");t(""),l(""),i(""),alert("Đổi mật khẩu th\xe0nh c\xf4ng")}catch(e){alert((null==e?void 0:e.message)||"Network error")}finally{c(!1)}};return(0,n.jsxs)("div",{className:"bg-white rounded-2xl border border-slate-200 shadow-sm p-5",children:[(0,n.jsx)("div",{className:"text-sm font-bold text-slate-800 mb-3",children:"Đổi mật khẩu"}),(0,n.jsxs)("div",{className:"grid gap-3",children:[(0,n.jsx)("input",{type:"password",value:e,onChange:e=>t(e.target.value),placeholder:"Mật khẩu hiện tại",className:"px-4 py-2 rounded-xl border border-slate-200 bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500"}),(0,n.jsx)("input",{type:"password",value:s,onChange:e=>l(e.target.value),placeholder:"Mật khẩu mới",className:"px-4 py-2 rounded-xl border border-slate-200 bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500"}),(0,n.jsx)("input",{type:"password",value:r,onChange:e=>i(e.target.value),placeholder:"Nhập lại mật khẩu mới",className:"px-4 py-2 rounded-xl border border-slate-200 bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500"}),(0,n.jsxs)("button",{onClick:x,disabled:d,className:"inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold disabled:opacity-50",children:[d?(0,n.jsx)(o.A,{className:"animate-spin",size:18}):null,"Lưu mật khẩu mới"]})]})]})}var c=s(5917),x=s(8104),h=s(6265),m=s(5894),u=s(8425),g=s(7734),p=s(3697),b=s(3420),f=s(46),v=s(4344),j=s(8202);let y=e=>{let{data:t,stats:s}=e;return(0,n.jsxs)("div",{className:"h-96 w-full bg-white p-6 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100/50 transition-all hover:shadow-[0_8px_30px_rgb(0,0,0,0.08)]",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,n.jsxs)("h3",{className:"text-lg font-bold text-slate-800 flex items-center gap-2",children:[(0,n.jsx)("span",{className:"w-2 h-6 bg-indigo-500 rounded-full inline-block"}),"Biểu đồ Học tập"]}),s&&(0,n.jsxs)("div",{className:"flex items-center gap-3 text-xs font-semibold",children:[(0,n.jsxs)("div",{className:"flex items-center gap-1 text-slate-500",children:[(0,n.jsx)("span",{className:"w-3 h-0.5 bg-orange-500"})," TB Lớp"]}),(0,n.jsxs)("div",{className:"flex items-center gap-1 text-slate-500",children:[(0,n.jsx)("span",{className:"w-3 h-0.5 bg-green-500"})," TB Khối"]})]})]}),(0,n.jsx)(h.u,{width:"100%",height:"85%",children:(0,n.jsxs)(m.b,{data:t,margin:{top:10,right:30,left:0,bottom:5},children:[(0,n.jsx)(u.d,{strokeDasharray:"3 3",stroke:"#f1f5f9",vertical:!1}),(0,n.jsx)(g.W,{dataKey:"month",stroke:"#94a3b8",tick:{fontSize:12,fill:"#64748b"},axisLine:!1,tickLine:!1,dy:10}),(0,n.jsx)(p.h,{domain:[0,10],stroke:"#94a3b8",tick:{fontSize:12,fill:"#64748b"},axisLine:!1,tickLine:!1,dx:-10}),(0,n.jsx)(b.m,{contentStyle:{borderRadius:"16px",border:"none",boxShadow:"0 10px 15px -3px rgb(0 0 0 / 0.1)",padding:"12px",backgroundColor:"rgba(255, 255, 255, 0.95)",backdropFilter:"blur(4px)"},cursor:{stroke:"#cbd5e1",strokeWidth:1,strokeDasharray:"4 4"}}),(0,n.jsx)(f.s,{wrapperStyle:{paddingTop:"20px"}}),(0,n.jsx)(v.N1,{connectNulls:!1,type:"monotone",dataKey:"math",name:"To\xe1n",stroke:"#3b82f6",strokeWidth:3,dot:{r:4,strokeWidth:2,fill:"#fff"},activeDot:{r:7,strokeWidth:0}}),(0,n.jsx)(v.N1,{connectNulls:!1,type:"monotone",dataKey:"lit",name:"Văn",stroke:"#ec4899",strokeWidth:3,dot:{r:4,strokeWidth:2,fill:"#fff"},activeDot:{r:7,strokeWidth:0}}),(0,n.jsx)(v.N1,{connectNulls:!1,type:"monotone",dataKey:"eng",name:"Anh",stroke:"#8b5cf6",strokeWidth:3,dot:{r:4,strokeWidth:2,fill:"#fff"},activeDot:{r:7,strokeWidth:0}}),s&&s.classAvg>0&&(0,n.jsx)(j.e_,{y:s.classAvg,stroke:"orange",strokeDasharray:"3 3",label:{position:"right",value:"TB Lớp",fill:"orange",fontSize:10}}),s&&s.gradeAvg>0&&(0,n.jsx)(j.e_,{y:s.gradeAvg,stroke:"green",strokeDasharray:"3 3",label:{position:"right",value:"TB Khối",fill:"green",fontSize:10}})]})})]})};var N=s(4926);function w(e){let{student:t,onLogout:s,streak:a}=e;return(0,n.jsx)("div",{className:"bg-white border-b border-slate-200/60 px-5 py-4 sticky top-0 z-20",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsxs)("div",{className:"text-slate-800 font-bold text-lg",children:["Xin ch\xe0o, ",(0,n.jsx)("span",{className:"uppercase",children:t.name})," \uD83D\uDC4B"]}),a>0&&(0,n.jsxs)("div",{className:"flex items-center gap-1 bg-orange-50 border border-orange-100 px-2 py-0.5 rounded-full",children:[(0,n.jsx)("span",{className:"text-sm",children:"\uD83D\uDD25"}),(0,n.jsxs)("span",{className:"text-xs font-bold text-orange-600",children:[a," ng\xe0y"]})]})]}),(0,n.jsxs)("div",{className:"text-xs text-slate-500 mt-0.5",children:["MHS: ",(0,n.jsx)("span",{className:"font-mono text-indigo-600",children:t.mhs})," | Lớp:"," ",(0,n.jsx)("span",{className:"font-semibold text-slate-700",children:t.class})]})]}),(0,n.jsxs)("button",{onClick:s,className:"flex items-center gap-2 text-sm font-semibold text-slate-600 hover:text-red-600 transition",children:[(0,n.jsx)(N.A,{size:16}),"Đăng xuất"]})]})})}function k(e){let{overviewText:t,strengthsText:s,risksText:a}=e;return(0,n.jsxs)("div",{className:"grid md:grid-cols-3 gap-4",children:[(0,n.jsxs)("div",{className:"rounded-2xl border border-orange-100 bg-orange-50/60 p-4",children:[(0,n.jsx)("div",{className:"text-sm font-bold text-orange-700 mb-2",children:"Tổng quan"}),(0,n.jsx)("div",{className:"text-sm text-slate-700 leading-relaxed",children:t})]}),(0,n.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-4",children:[(0,n.jsx)("div",{className:"text-sm font-bold text-slate-800 mb-2",children:"Điểm mạnh"}),(0,n.jsxs)("div",{className:"text-sm text-slate-700 leading-relaxed",children:["• ",s]})]}),(0,n.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-4",children:[(0,n.jsx)("div",{className:"text-sm font-bold text-slate-800 mb-2",children:"Cần lưu \xfd"}),(0,n.jsxs)("div",{className:"text-sm text-slate-700 leading-relaxed",children:["• ",a]})]})]})}var S=s(368),A=s(7937);function T(e){let{selectedTaskMonthSafe:t,selectedDate:s,monthKeys:a,canPrevMonth:l,canNextMonth:r,onSelectMonth:i,onSelectDate:o,onPrevMonth:d,onNextMonth:c}=e;return(0,n.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"text-sm font-bold text-slate-800",children:"Th\xf3i quen H\xe0ng ng\xe0y"}),(0,n.jsxs)("div",{className:"text-xs text-slate-500",children:["Nhiệm vụ theo th\xe1ng: ",(0,n.jsx)("b",{children:t})," (th\xe1ng sau c\xf3 thể kh\xe1c)."]})]}),(0,n.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,n.jsx)("button",{onClick:d,disabled:!l,className:"p-2 rounded-xl border border-slate-200 bg-white disabled:opacity-40",title:"Th\xe1ng trước",children:(0,n.jsx)(S.A,{size:18})}),(0,n.jsx)("select",{value:t,onChange:e=>i(e.target.value),className:"px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-semibold text-slate-700",children:a.map(e=>(0,n.jsx)("option",{value:e,children:e},e))}),(0,n.jsx)("button",{onClick:c,disabled:!r,className:"p-2 rounded-xl border border-slate-200 bg-white disabled:opacity-40",title:"Th\xe1ng sau",children:(0,n.jsx)(A.A,{size:18})}),(0,n.jsx)("input",{type:"date",value:s,onChange:e=>o(e.target.value),className:"px-3 py-2 rounded-xl border border-slate-200 text-sm bg-white"})]})]})}var C=s(6613),D=s(3997),M=s(2472);function L(e){let{leaderboardClass:t,leaderboardGrade:s,currentMhs:l}=e,[r,i]=(0,a.useState)("class"),o="class"===r?t:s;return(0,n.jsxs)("div",{className:"bg-white rounded-2xl border border-slate-200 shadow-sm p-5",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(C.A,{className:"text-indigo-600",size:20}),(0,n.jsx)("div",{className:"text-sm font-bold text-slate-800",children:"Bảng Xếp Hạng (Th\xe1ng n\xe0y)"})]}),(0,n.jsxs)("div",{className:"flex bg-slate-100 p-1 rounded-xl",children:[(0,n.jsx)("button",{onClick:()=>i("class"),className:"px-3 py-1.5 rounded-lg text-xs font-bold transition ".concat("class"===r?"bg-white text-indigo-600 shadow-sm":"text-slate-500 hover:text-slate-600"),children:"Lớp"}),(0,n.jsx)("button",{onClick:()=>i("grade"),className:"px-3 py-1.5 rounded-lg text-xs font-bold transition ".concat("grade"===r?"bg-white text-indigo-600 shadow-sm":"text-slate-500 hover:text-slate-600"),children:"To\xe0n Khối"})]})]}),(0,n.jsx)("div",{className:"space-y-3",children:0===o.length?(0,n.jsx)("div",{className:"text-center py-4 text-xs text-slate-400 italic",children:"Chưa c\xf3 dữ liệu xếp hạng."}):o.map(e=>{var t,s;let a=e.id===l;return(0,n.jsxs)("div",{className:"flex items-center justify-between p-3 rounded-xl border ".concat(1===(t=e.rank)?"bg-yellow-50 border-yellow-200":2===t?"bg-slate-50 border-slate-200":3===t?"bg-orange-50 border-orange-200":"bg-white border-slate-100"," ").concat(a?"ring-2 ring-indigo-500 ring-offset-2":""),children:[(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)("div",{className:"flex-shrink-0 w-8 flex justify-center",children:1===(s=e.rank)?(0,n.jsx)(C.A,{size:20,className:"text-yellow-500"}):2===s?(0,n.jsx)(D.A,{size:20,className:"text-gray-400"}):3===s?(0,n.jsx)(M.A,{size:20,className:"text-orange-500"}):(0,n.jsx)("span",{className:"text-sm font-bold text-slate-500 w-5 text-center",children:s})}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"text-sm font-bold text-slate-800 flex items-center gap-2",children:[e.name,a&&(0,n.jsx)("span",{className:"text-[10px] bg-indigo-600 text-white px-1.5 rounded",children:"Bạn"})]}),(0,n.jsx)("div",{className:"text-[10px] text-slate-500",children:e.class})]})]}),(0,n.jsxs)("div",{className:"text-right",children:[(0,n.jsx)("div",{className:"text-sm font-bold text-slate-800",children:e.score}),(0,n.jsx)("div",{className:"text-[10px] text-slate-400 uppercase",children:"Ticks"})]})]},e.id)})}),(0,n.jsx)("div",{className:"mt-4 text-[11px] text-slate-400 text-center",children:"* Xếp hạng dựa tr\xean tổng số nhiệm vụ ho\xe0n th\xe0nh trong th\xe1ng."})]})}function z(e){let t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return"".concat(t,"-").concat(s,"-").concat(n)}function E(e){return z(e).slice(0,7)}function R(e){var t,s;let n=Array.isArray(e)?e:[],a=null==(s=n[n.length-1])||null==(t=s.month)?void 0:t.trim();return a&&/^\d{4}-\d{2}$/.test(a)?a:E(new Date)}function O(e){let t=e.actionsByMonth;return t&&"object"==typeof t?t:{}}function B(e,t){let s=O(e),n=null==s?void 0:s[t];return Array.isArray(n)&&n.length?n:Array.isArray(e.activeActions)?e.activeActions:[]}function P(e){let t=new Map;return(e.ticks||[]).forEach(e=>t.set(String(e.date),!!e.completed)),t}function q(e){var t,s,l;let{student:r,onUpdateAction:i,onLogout:o}=e,h=(0,a.useMemo)(()=>(function(e){let t=String(e||"").trim();if(!/^\d{4}-\d{2}$/.test(t))return E(new Date);let[s,n]=t.split("-"),a=Number(s),l=Number(n);return a&&l?(13===(l+=1)&&(l=1,a+=1),"".concat(String(a).padStart(4,"0"),"-").concat(String(l).padStart(2,"0"))):E(new Date)})(R(r.scores)),[r.scores]),[m,u]=(0,a.useState)(()=>E(new Date)),[g,p]=(0,a.useState)(()=>z(new Date)),[b,f]=(0,a.useState)("range"),[v,j]=(0,a.useState)(30),N=(0,a.useMemo)(()=>Array.from(new Set([...(r.scores||[]).map(e=>String(e.month||"").trim()).filter(e=>/^\d{4}-\d{2}$/.test(e)),...Object.keys(O(r)).filter(e=>/^\d{4}-\d{2}$/.test(e)),h,E(new Date)])).sort((e,t)=>e.localeCompare(t)),[r,h]),S=(0,a.useMemo)(()=>{if(N.includes(m))return m;let e=E(new Date);return N.includes(e)?e:h},[m,N,h]);(0,a.useEffect)(()=>{let e=z(new Date);g.slice(0,7)!==S&&(e.startsWith(S)?p(e):p("".concat(S,"-01")))},[S]),(0,a.useEffect)(()=>{let e=new Date,t=E(e),s=z(e);u(t),p(s)},[]);let A=(0,a.useMemo)(()=>B(r,S),[r,S]),C=(0,a.useMemo)(()=>"month"===b?function(e){let[t,s]=e.split("-"),n=Number(t),a=Number(s);if(!n||!a)return[];let l=new Date(n,a,0).getDate(),r=[];for(let e=1;e<=l;e++){let n=String(e).padStart(2,"0");r.push("".concat(t,"-").concat(s,"-").concat(n))}return r}(S):(function(e){let t=[],s=new Date;for(let n=e-1;n>=0;n--){let e=new Date(s);e.setDate(s.getDate()-n),t.push(z(e))}return t})(v).filter(e=>e.slice(0,7)===S),[b,v,S]),D=(0,a.useMemo)(()=>B(r,S),[r,S]),M=r.aiReport,q=(null==M?void 0:M.overview)||"Tổng quan: dữ liệu mới nhất th\xe1ng ".concat(R(r.scores),"."),H=(null==M?void 0:M.strengths)&&M.strengths[0]||"C\xf3 dữ liệu theo d\xf5i theo th\xe1ng.",_=(null==M?void 0:M.risks)&&M.risks[0]||"Cần duy tr\xec th\xf3i quen học đều.",K=(0,a.useMemo)(()=>{let e=Array.isArray(null==M?void 0:M.studyPlan)?M.studyPlan:[],t=new Map;for(let s of e){let e=String(s.day||"").trim()||"Kh\xe1c";t.has(e)||t.set(e,[]),t.get(e).push(s)}return Array.from(t.entries())},[M]),I=(0,a.useMemo)(()=>(function(e){let t,s=new Set;if(Object.values(O(e)).forEach(e=>{e.forEach(e=>{var t;null==(t=e.ticks)||t.forEach(e=>{e.completed&&s.add(String(e.date))})})}),Array.isArray(e.activeActions)&&e.activeActions.forEach(e=>{var t;null==(t=e.ticks)||t.forEach(e=>{e.completed&&s.add(String(e.date))})}),0===s.size)return 0;let n=new Date,a=z(n),l=new Date(n);l.setDate(l.getDate()-1);let r=z(l);if(s.has(a))t=n;else{if(!s.has(r))return 0;t=l}let i=0;for(let e=0;e<3650;e++){let e=z(t);if(s.has(e))i++,t.setDate(t.getDate()-1);else break}return i})(r),[r]),W=async e=>{let t=!!P(e).get(g);await i(e.id,g,!t)},U=N.indexOf(S),F=U>0,J=U>=0&&U<N.length-1;return(0,n.jsxs)("div",{className:"min-h-screen bg-[#f7f9fc] font-sans",children:[(0,n.jsx)(w,{student:r,onLogout:o,streak:I}),(0,n.jsxs)("div",{className:"max-w-5xl mx-auto px-5 py-6 space-y-6",children:[(0,n.jsx)(k,{overviewText:q,strengthsText:H,risksText:_}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[(0,n.jsxs)("div",{className:"md:col-span-2 bg-white rounded-2xl border border-slate-200 shadow-sm p-5",children:[(0,n.jsx)("div",{className:"text-sm font-bold text-slate-800 mb-4",children:"Biểu đồ Học tập"}),(0,n.jsx)(y,{data:r.scores||[],stats:r.dashboardStats})]}),(0,n.jsx)("div",{className:"md:col-span-1",children:(0,n.jsx)(L,{leaderboardClass:(null==(t=r.dashboardStats)?void 0:t.leaderboardClass)||[],leaderboardGrade:(null==(s=r.dashboardStats)?void 0:s.leaderboardGrade)||[],currentMhs:r.mhs})})]}),(0,n.jsxs)("div",{className:"bg-white rounded-2xl border border-slate-200 shadow-sm p-5",children:[(0,n.jsx)(T,{selectedTaskMonthSafe:S,selectedDate:g,monthKeys:N,canPrevMonth:F,canNextMonth:J,onSelectMonth:u,onSelectDate:p,onPrevMonth:()=>F&&u(N[U-1]),onNextMonth:()=>J&&u(N[U+1])}),0===A.length?(0,n.jsxs)("div",{className:"text-sm text-slate-400 italic py-6 text-center",children:["Chưa c\xf3 nhiệm vụ cho th\xe1ng ",S,"."]}):(0,n.jsx)("div",{className:"space-y-3",children:A.map(e=>{let t=!!P(e).get(g);return(0,n.jsx)("button",{onClick:()=>W(e),className:"w-full text-left rounded-2xl border p-4 transition ".concat(t?"border-emerald-200 bg-emerald-50/50":"border-slate-200 bg-white hover:bg-slate-50"),children:(0,n.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,n.jsxs)("div",{className:"flex items-start gap-3",children:[(0,n.jsx)("div",{className:"mt-0.5 w-5 h-5 rounded-full border flex items-center justify-center ".concat(t?"bg-emerald-500 border-emerald-500 text-white":"border-slate-300 text-transparent"),children:(0,n.jsx)(c.A,{size:14})}),(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"text-sm font-semibold ".concat(t?"text-slate-700":"text-slate-800"),children:e.description}),(0,n.jsx)("div",{className:"text-xs text-slate-500 mt-1",children:e.frequency})]})]}),(0,n.jsx)("div",{className:"text-xs text-slate-400",children:g})]})},e.id)})})]}),(0,n.jsxs)("div",{className:"bg-white rounded-2xl border border-slate-200 shadow-sm p-5",children:[(0,n.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(x.A,{size:18,className:"text-indigo-600"}),(0,n.jsx)("div",{className:"text-sm font-bold text-slate-800",children:"Theo d\xf5i Th\xf3i quen (d\xe0i hạn)"})]}),(0,n.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,n.jsx)("button",{onClick:()=>f("range"),className:"px-3 py-2 rounded-xl text-sm font-semibold border ".concat("range"===b?"bg-indigo-600 text-white border-indigo-600":"bg-white text-slate-700 border-slate-200 hover:bg-slate-50"),children:"7/30/90 ng\xe0y"}),(0,n.jsx)("button",{onClick:()=>f("month"),className:"px-3 py-2 rounded-xl text-sm font-semibold border ".concat("month"===b?"bg-indigo-600 text-white border-indigo-600":"bg-white text-slate-700 border-slate-200 hover:bg-slate-50"),children:"Theo th\xe1ng"}),"range"===b&&(0,n.jsx)(n.Fragment,{children:[7,30,90].map(e=>(0,n.jsxs)("button",{onClick:()=>j(e),className:"px-3 py-2 rounded-xl text-sm font-semibold border ".concat(v===e?"bg-emerald-600 text-white border-emerald-600":"bg-white text-slate-700 border-slate-200 hover:bg-slate-50"),children:[e," ng\xe0y"]},e))})]})]}),0===D.length?(0,n.jsxs)("div",{className:"text-sm text-slate-400 italic py-6 text-center",children:["Chưa c\xf3 nhiệm vụ để theo d\xf5i trong th\xe1ng ",S,"."]}):(0,n.jsx)("div",{className:"space-y-4",children:D.map(e=>{let t=P(e),s=C.reduce((e,s)=>e+ +!!t.get(s),0);return(0,n.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-4",children:[(0,n.jsxs)("div",{className:"flex items-start justify-between gap-3 mb-3",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"text-sm font-bold text-slate-800",children:e.description}),(0,n.jsxs)("div",{className:"text-xs text-slate-500 mt-1",children:["Tần suất: ",e.frequency]})]}),(0,n.jsxs)("div",{className:"text-right",children:[(0,n.jsx)("div",{className:"text-2xl font-bold text-indigo-600",children:s}),(0,n.jsx)("div",{className:"text-[10px] text-slate-500 uppercase font-bold tracking-wider",children:"Tổng tick"})]})]}),(0,n.jsx)("div",{className:"overflow-x-auto",children:(0,n.jsx)("div",{className:"flex items-center gap-2 min-w-max",children:C.map(s=>{let a=!!t.get(s);return(0,n.jsx)("button",{onClick:async()=>{await i(e.id,s,!a)},className:"w-10 h-10 rounded-xl border flex items-center justify-center text-xs font-semibold transition ".concat(a?"bg-emerald-100 text-emerald-700 border-emerald-200":"bg-white text-slate-400 border-slate-200 hover:bg-slate-50"),title:s,children:a?(0,n.jsx)(c.A,{size:18}):(0,n.jsx)("span",{className:"text-[10px]",children:function(e){let t=new Date(e);return"".concat(t.getDate(),"/").concat(t.getMonth()+1)}(s)})},s)})})}),(0,n.jsx)("div",{className:"text-[11px] text-slate-500 mt-3",children:"Nếu nhiệm vụ “3 lần/tuần” th\xec trong 1 tuần tick đủ 3 ng\xe0y l\xe0 đạt."})]},e.id)})})]}),(0,n.jsxs)("div",{className:"bg-white rounded-2xl border border-slate-200 shadow-sm p-5",children:[(0,n.jsx)("div",{className:"text-sm font-bold text-slate-800 mb-4",children:"Kế hoạch 2 Tuần tới"}),(null==M||null==(l=M.studyPlan)?void 0:l.length)?(0,n.jsx)("div",{className:"space-y-4",children:K.map(e=>{let[t,s]=e;return(0,n.jsxs)("div",{className:"grid md:grid-cols-5 gap-3",children:[(0,n.jsx)("div",{className:"text-xs font-bold text-slate-400 uppercase md:pt-3",children:t}),(0,n.jsx)("div",{className:"md:col-span-4 space-y-3",children:s.map((e,t)=>(0,n.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-slate-50/40 p-4",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,n.jsx)("span",{className:"text-[10px] font-bold uppercase px-2 py-0.5 rounded bg-white border border-slate-200 text-slate-600",children:e.subject}),(0,n.jsx)("span",{className:"text-xs text-slate-500",children:e.duration})]}),(0,n.jsx)("div",{className:"text-sm font-semibold text-slate-800",children:e.content})]},t))})]},t)})}):(0,n.jsx)("div",{className:"text-sm text-slate-400 italic py-6 text-center",children:"Chưa c\xf3 kế hoạch."})]}),(0,n.jsx)(d,{}),(0,n.jsxs)("div",{className:"rounded-2xl bg-gradient-to-r from-indigo-600 to-violet-600 text-white p-5 shadow-sm",children:[(0,n.jsx)("div",{className:"text-sm font-bold mb-2",children:"✨ Lời nhắn từ AI Mentor"}),(0,n.jsxs)("div",{className:"text-sm italic",children:["“",(null==M?void 0:M.messageToStudent)||"Mỗi ng\xe0y tiến bộ 1 ch\xfat l\xe0 đủ.","”"]}),(0,n.jsx)("div",{className:"text-[10px] text-white/60 mt-4 uppercase tracking-wider",children:"DISCLAIMER:"}),(0,n.jsx)("div",{className:"text-[11px] text-white/70",children:(null==M?void 0:M.disclaimer)||"Nhận x\xe9t AI chỉ mang t\xednh tham khảo, gi\xe1o vi\xean sẽ điều chỉnh theo thực tế."})]})]})]})}var H=s(8314);function _(e){let{mhs:t}=e,[s,l]=(0,a.useState)(!1),r=async()=>{if(confirm("Reset mật khẩu HS ".concat(t," về DEFAULT_PASSWORD?"))){l(!0);try{let e=await fetch("/api/account/reset-password",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({mhs:t})}),s=await e.json().catch(()=>({}));if(!e.ok||!(null==s?void 0:s.ok))return alert((null==s?void 0:s.error)||"Reset thất bại");alert("Reset OK (NEW_PASSWORD đ\xe3 x\xf3a, quay về DEFAULT_PASSWORD)")}catch(e){alert((null==e?void 0:e.message)||"Network error")}finally{l(!1)}}};return(0,n.jsxs)("button",{onClick:r,disabled:s,className:"inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-bold disabled:opacity-50",title:"Reset về mật khẩu mặc định",children:[s?(0,n.jsx)(o.A,{className:"animate-spin",size:14}):(0,n.jsx)(H.A,{size:14}),"Reset MK"]})}var K=s(5867),I=s(5229);function W(){let[e,t]=(0,a.useState)(!1),[s,l]=(0,a.useState)(""),[r,i]=(0,a.useState)(""),[d,c]=(0,a.useState)(!1),[x,h]=(0,a.useState)("");(0,a.useEffect)(()=>{if(!e)return;let s=document.body.style.overflow;document.body.style.overflow="hidden";let n=e=>{"Escape"===e.key&&t(!1)};return window.addEventListener("keydown",n),()=>{window.removeEventListener("keydown",n),document.body.style.overflow=s}},[e]);let m=()=>{t(!1),h(""),l(""),i(""),c(!1)},u=async()=>{if(h(""),!r.trim())return void h("Vui l\xf2ng nhập mật khẩu mới.");c(!0);try{let e=await fetch("/api/account/admin/change-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldPassword:s,newPassword:r})}),t=await e.json().catch(()=>({}));if(!e.ok||!(null==t?void 0:t.ok))return void h((null==t?void 0:t.error)||"Đổi mật khẩu thất bại");h("✅ Đổi mật khẩu th\xe0nh c\xf4ng"),setTimeout(()=>m(),800)}finally{c(!1)}};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("button",{type:"button",onClick:()=>t(!0),className:"flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-semibold rounded-xl",title:"Đổi mật khẩu Admin",children:[(0,n.jsx)(K.A,{size:16}),"Đổi MK Admin"]}),e&&(0,n.jsx)("div",{className:"fixed inset-0 z-[200] bg-slate-900/55 backdrop-blur-sm flex items-center justify-center p-4",onMouseDown:e=>{e.target===e.currentTarget&&m()},children:(0,n.jsxs)("div",{className:"bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden",children:[(0,n.jsxs)("div",{className:"p-5 border-b border-slate-100 flex items-start justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"text-lg font-bold text-slate-800",children:"Đổi mật khẩu Admin"}),(0,n.jsx)("div",{className:"text-xs text-slate-500 mt-1",children:"Nếu qu\xean mật khẩu: d\xf9ng luồng reset qua email."})]}),(0,n.jsx)("button",{type:"button",onClick:m,className:"p-2 rounded-xl hover:bg-slate-100 text-slate-500",title:"Đ\xf3ng",children:(0,n.jsx)(I.A,{size:18})})]}),(0,n.jsxs)("div",{className:"p-5 space-y-3",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"text-sm font-semibold text-slate-700 mb-1",children:"Mật khẩu cũ"}),(0,n.jsx)("input",{type:"password",value:s,onChange:e=>l(e.target.value),className:"w-full px-3 py-2.5 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none",placeholder:"(nếu bạn c\xf3 d\xf9ng kiểm tra mật khẩu cũ)"})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"text-sm font-semibold text-slate-700 mb-1",children:"Mật khẩu mới"}),(0,n.jsx)("input",{type:"password",value:r,onChange:e=>i(e.target.value),className:"w-full px-3 py-2.5 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none",placeholder:"Nhập mật khẩu mới"})]}),x&&(0,n.jsx)("div",{className:"text-sm px-3 py-2 rounded-xl bg-slate-50 border border-slate-200 text-slate-700",children:x})]}),(0,n.jsxs)("div",{className:"p-5 border-t border-slate-100 flex justify-end gap-2 bg-white",children:[(0,n.jsx)("button",{type:"button",onClick:m,className:"px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold",children:"Hủy"}),(0,n.jsxs)("button",{type:"button",onClick:u,disabled:d,className:"px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-semibold disabled:opacity-50 inline-flex items-center gap-2",children:[d?(0,n.jsx)(o.A,{size:18,className:"animate-spin"}):null,"Đổi mật khẩu"]})]})]})})]})}var U=s(5740),F=s(6651),J=s(1786),G=s(1169),X=s(2056),V=s(9715),$=s(534),Q=s(1190),Y=s(6046),Z=s(906);function ee(e){return e.toISOString().slice(0,10)}function et(e){return e.toISOString().slice(0,7)}function es(e){return/^\d{4}-\d{2}$/.test(String(e||"").trim())}function en(e){let t=String(e||"").trim();if(!es(t))return et(new Date);let[s,n]=t.split("-"),a=parseInt(s,10),l=parseInt(n,10);return 13===(l+=1)&&(l=1,a+=1),"".concat(String(a).padStart(4,"0"),"-").concat(String(l).padStart(2,"0"))}function ea(e){return en(function(e){let t=Array.isArray(null==e?void 0:e.scores)?e.scores:[],s=t.length?t[t.length-1]:null,n=String((null==s?void 0:s.month)||"").trim();return es(n)?n:et(new Date)}(e))}function el(e){let t=new Set;((null==e?void 0:e.scores)||[]).forEach(e=>{let s=String((null==e?void 0:e.month)||"").trim();es(s)&&(t.add(s),t.add(en(s)))}),((null==e?void 0:e.activeActions)||[]).forEach(e=>{((null==e?void 0:e.ticks)||[]).forEach(e=>{let s=String((null==e?void 0:e.date)||"").slice(0,7);es(s)&&t.add(s)})});let s=null==e?void 0:e.actionsByMonth;s&&"object"==typeof s&&Object.keys(s).forEach(e=>{let n=String(e||"").trim();es(n)&&t.add(n);let a=s[e];Array.isArray(a)&&a.forEach(e=>{((null==e?void 0:e.ticks)||[]).forEach(e=>{let s=String((null==e?void 0:e.date)||"").slice(0,7);es(s)&&t.add(s)})})}),e&&t.add(ea(e));let n=Array.from(t);return n.sort(),n}function er(e){if(!e)return{};let t=null==e?void 0:e.actionsByMonth;return t&&"object"==typeof t?t:{[ea(e)]:Array.isArray(null==e?void 0:e.activeActions)?e.activeActions:[]}}async function ei(e,t,s,n){let a=await fetch("/api/admin/save-report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mhs:e,report:t,actions:s,monthKey:n})}),l=await a.json().catch(()=>({}));if(!a.ok||!(null==l?void 0:l.ok))throw Error((null==l?void 0:l.error)||"Save report failed");return l}let eo=e=>{let{students:t,onImportData:s,onUpdateStudentReport:l,onLogout:r}=e,[d,h]=(0,a.useState)(null),[m,u]=(0,a.useState)(null),[g,p]=(0,a.useState)(""),[b,f]=(0,a.useState)("report"),[v,j]=(0,a.useState)(new Set),[y,N]=(0,a.useState)("ALL"),[w,k]=(0,a.useState)("none"),[S,A]=(0,a.useState)(null),T=(null==S?void 0:S.role)==="TEACHER",C=String((null==S?void 0:S.teacherClass)||"").trim();(0,a.useEffect)(()=>{fetch("/api/me").then(e=>e.json()).then(e=>A((null==e?void 0:e.session)||null)).catch(()=>A(null))},[]);let D=(0,a.useMemo)(()=>T&&C?t.filter(e=>String(e.class||"").trim()===C):t,[t,T,C]);(0,a.useEffect)(()=>{T&&j(e=>{let t=new Set;for(let s of e)D.find(e=>e.mhs===s)&&t.add(s);return t})},[T,D]);let[M,L]=(0,a.useState)(null),[z,E]=(0,a.useState)(!1),[R,O]=(0,a.useState)({overview:"",messageToStudent:"",teacherNotes:""}),B=D.find(e=>e.mhs===m),[P,q]=(0,a.useState)("7"),[H,K]=(0,a.useState)(et(new Date));(0,a.useEffect)(()=>{if(!B)return;let e=el(B),t=ea(B),s=e.length?e[e.length-1]:t;K(e.includes(t)?t:s)},[null==B?void 0:B.mhs]);let[es,en]=(0,a.useState)(!1),[eo,ed]=(0,a.useState)(!1),[ec,ex]=(0,a.useState)([]),[eh,em]=(0,a.useState)(new Set),[eu,eg]=(0,a.useState)(""),[ep,eb]=(0,a.useState)(""),ef=(0,a.useMemo)(()=>Array.from(new Set(D.map(e=>e.class||"").filter(Boolean))).sort(),[D]),ev=(0,a.useMemo)(()=>{let e=g.toLowerCase(),t=D.filter(t=>("ALL"===y||t.class===y)&&(t.name.toLowerCase().includes(e)||t.mhs.toLowerCase().includes(e)||t.class.toLowerCase().includes(e)));return"none"!==w&&(t=t.slice().sort((e,t)=>{let s=e=>{var t;let s=ea(e),n=er(e);return(Array.isArray(null==e||null==(t=e.actionsByMonth)?void 0:t[s])?e.actionsByMonth[s]:Array.isArray(null==n?void 0:n[s])?n[s]:Array.isArray(e.activeActions)?e.activeActions:[]).reduce((e,t)=>e+(Array.isArray(null==t?void 0:t.ticks)?t.ticks:[]).filter(e=>(null==e?void 0:e.completed)&&String((null==e?void 0:e.date)||"").slice(0,7)===s).length,0)},n=s(e),a=s(t);return"desc"===w?a-n:n-a})),t},[D,g,y,w]);(0,a.useEffect)(()=>{B&&B.aiReport&&(O({overview:B.aiReport.overview,messageToStudent:B.aiReport.messageToStudent,teacherNotes:B.aiReport.teacherNotes}),E(!1))},[B]);let ej=(0,a.useMemo)(()=>er(B),[null==B?void 0:B.mhs,null==B?void 0:B.activeActions,null==B?void 0:B.scores,null==B?void 0:B.actionsByMonth]),ey=(0,a.useMemo)(()=>{let e=el(B);return e.length?e:[et(new Date)]},[null==B?void 0:B.mhs,null==B?void 0:B.actionsByMonth,null==B?void 0:B.scores,null==B?void 0:B.activeActions]),eN=(0,a.useMemo)(()=>B?ea(B):et(new Date),[null==B?void 0:B.mhs,null==B?void 0:B.scores]),ew=(0,a.useMemo)(()=>"month"===P?H:eN,[P,H,eN]),ek=(0,a.useMemo)(()=>"month"===P?function(e){let[t,s]=e.split("-").map(e=>parseInt(e,10));if(!t||!s)return[];let n=new Date(Date.UTC(t,s-1,1)),a=new Date(Date.UTC(t,s,0)),l=[],r=new Date(n);for(;r<=a;)l.push(ee(r)),r.setUTCDate(r.getUTCDate()+1);return l}(H):(function(e){let t=[];for(let s=e-1;s>=0;s--){let e=new Date;e.setDate(e.getDate()-s),t.push(ee(e))}return t})("7"===P?7:"30"===P?30:90).filter(e=>e.slice(0,7)===ew),[P,H,ew]),eS=(0,a.useMemo)(()=>{let e=null==ej?void 0:ej[ew];return Array.isArray(e)?e:Array.isArray(null==B?void 0:B.activeActions)?B.activeActions:[]},[ej,ew,null==B?void 0:B.mhs]),eA=(0,a.useMemo)(()=>"month"===P?"Tiến độ Th\xf3i quen (Th\xe1ng ".concat(H,") • Nhiệm vụ th\xe1ng ").concat(H):"30"===P?"Tiến độ Th\xf3i quen (30 ng\xe0y qua) • Nhiệm vụ th\xe1ng ".concat(ew):"90"===P?"Tiến độ Th\xf3i quen (90 ng\xe0y qua) • Nhiệm vụ th\xe1ng ".concat(ew):"Tiến độ Th\xf3i quen (7 ng\xe0y qua) • Nhiệm vụ th\xe1ng ".concat(ew),[P,H,ew]),eT=async e=>{var t;if(T)return;let n=null==(t=e.target.files)?void 0:t[0];if(!n)return;let a=new FileReader;a.onload=e=>{var t;let n=null==(t=e.target)?void 0:t.result,a=XLSX.read(n,{type:"binary"}),l=new Map;D.forEach(e=>l.set(e.mhs,{...e})),a.SheetNames.forEach(e=>{let t=a.Sheets[e],s=XLSX.utils.sheet_to_json(t,{header:1});for(let t=1;t<s.length;t++){let n=s[t],a=n[1]?String(n[1]).trim():null;if(!a)continue;let r=n[2]?String(n[2]).trim():"Unknown",i=n[3]?String(n[3]).trim():"",o=e=>{if(null==e||""===e)return null;let t=parseFloat(e);return isNaN(t)?null:t},d=o(n[5]),c=o(n[6]),x=o(n[7]);if(null===d&&null===c&&null===x)continue;let h={month:e,math:d,lit:c,eng:x},m=l.get(a);m?(m.name=r,m.class=i):(m={mhs:a,name:r,class:i,scores:[],activeActions:[]},l.set(a,m));let u=m.scores.findIndex(t=>t.month===e);u>=0?m.scores[u]=h:m.scores.push(h)}});let r=Array.from(l.values());s(r),alert("Nhập th\xe0nh c\xf4ng! Đ\xe3 xử l\xfd ".concat(r.length," học sinh qua ").concat(a.SheetNames.length," sheet th\xe1ng."))},a.readAsBinaryString(n)},eC=async e=>{h(e.mhs);try{let t=await i(e),s=ea(e),n=(t.actions||[]).map((t,s)=>({id:"".concat(e.mhs,"-").concat(Date.now(),"-").concat(s),description:t.description,frequency:t.frequency,ticks:[]}));await ei(e.mhs,t,n,s),l(e.mhs,t,n)}catch(e){alert((null==e?void 0:e.message)||"Kh\xf4ng thể tạo b\xe1o c\xe1o. Vui l\xf2ng kiểm tra API Key.")}finally{h(null)}},eD=async()=>{if(T)return;let e=ev.filter(e=>v.has(e.mhs));if(0===e.length)return void alert("Bạn chưa chọn học sinh n\xe0o.");if(confirm("Bạn c\xf3 chắc muốn tạo b\xe1o c\xe1o AI cho ".concat(e.length," học sinh đang chọn kh\xf4ng?"))){L({current:0,total:e.length,currentName:""});for(let t=0;t<e.length;t++){let s=e[t];L({current:t+1,total:e.length,currentName:s.name});try{let e=await i(s),t=ea(s),n=(e.actions||[]).map((e,t)=>({id:"".concat(s.mhs,"-").concat(Date.now(),"-").concat(t),description:e.description,frequency:e.frequency,ticks:[]}));await ei(s.mhs,e,n,t),l(s.mhs,e,n)}catch(e){console.error("Failed to generate for ".concat(s.mhs),e)}t<e.length-1&&await new Promise(e=>setTimeout(e,2e3))}L(null),alert("Ho\xe0n tất qu\xe1 tr\xecnh tạo b\xe1o c\xe1o h\xe0ng loạt!")}},eM=async()=>{if(!T){en(!0),eb("");try{var e,t,s;let n=await fetch("/api/sync/sheets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:"new_only"})}),a=await n.json();if(!n.ok||!(null==a?void 0:a.ok))return void alert("Lỗi đồng bộ: ".concat((null==a?void 0:a.error)||"Sync failed"));let l=null!=(e=a.monthsSynced)?e:[],r=null!=(t=a.monthsAll)?t:[];if(l.length>0){alert("Đồng bộ xong: ".concat(null!=(s=a.students)?s:0," HS. Th\xe1ng mới: ").concat(l.join(", "))),window.location.reload();return}ex(r),em(new Set(r)),eg(""),eb("Kh\xf4ng c\xf3 th\xe1ng mới. Bạn c\xf3 thể chọn th\xe1ng để đồng bộ lại."),ed(!0)}catch(e){alert("Lỗi đồng bộ: ".concat((null==e?void 0:e.message)||"Network error"))}finally{en(!1)}}},eL=(0,a.useMemo)(()=>{let e=eu.trim().toLowerCase();return e?ec.filter(t=>t.toLowerCase().includes(e)):ec},[ec,eu]),ez=e=>{em(t=>{let s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})},eE=async()=>{if(T)return;let e=Array.from(eh).sort();if(0===e.length)return void alert("Bạn chưa chọn th\xe1ng n\xe0o.");en(!0);try{var t,s;let n=await fetch("/api/sync/sheets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:"months",selectedMonths:e})}),a=await n.json();if(!n.ok||!(null==a?void 0:a.ok))return void alert("Lỗi đồng bộ: ".concat((null==a?void 0:a.error)||"Sync failed"));ed(!1),alert("Đồng bộ xong: ".concat(null!=(t=a.students)?t:0," HS. Th\xe1ng: ").concat((null!=(s=a.monthsSynced)?s:e).join(", "))),window.location.reload()}catch(e){alert("Lỗi đồng bộ: ".concat((null==e?void 0:e.message)||"Network error"))}finally{en(!1)}},eR=async()=>{if(!B||!B.aiReport)return;let e={...B.aiReport,overview:R.overview,messageToStudent:R.messageToStudent,teacherNotes:R.teacherNotes},t=ea(B);try{await ei(B.mhs,e,eS,t),l(B.mhs,e,eS),E(!1)}catch(e){alert((null==e?void 0:e.message)||"Lưu thất bại")}};return(0,n.jsxs)("div",{className:"min-h-screen bg-[#f8fafc] flex flex-col font-sans relative",children:[M&&(0,n.jsx)("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center",children:(0,n.jsxs)("div",{className:"bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center animate-in fade-in zoom-in duration-300",children:[(0,n.jsx)("div",{className:"w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse",children:(0,n.jsx)(U.A,{size:32})}),(0,n.jsx)("h3",{className:"text-xl font-bold text-slate-800 mb-2",children:"Đang ph\xe2n t\xedch dữ liệu..."}),(0,n.jsxs)("p",{className:"text-slate-500 mb-6",children:["Đang xử l\xfd: ",(0,n.jsx)("span",{className:"font-bold text-indigo-600",children:M.currentName})]}),(0,n.jsx)("div",{className:"w-full bg-slate-100 rounded-full h-4 mb-2 overflow-hidden",children:(0,n.jsx)("div",{className:"bg-indigo-600 h-4 rounded-full transition-all duration-500 ease-out",style:{width:"".concat(M.current/M.total*100,"%")}})}),(0,n.jsxs)("div",{className:"flex justify-between text-xs font-semibold text-slate-400 uppercase tracking-wider",children:[(0,n.jsx)("span",{children:"Tiến độ"}),(0,n.jsxs)("span",{children:[M.current," / ",M.total]})]}),(0,n.jsx)("p",{className:"text-xs text-slate-400 mt-4 italic",children:"Vui l\xf2ng kh\xf4ng tắt tr\xecnh duyệt..."})]})}),eo&&!T&&(0,n.jsx)("div",{className:"fixed inset-0 bg-slate-900/55 backdrop-blur-sm z-[120] flex items-center justify-center p-4",children:(0,n.jsxs)("div",{className:"bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden",children:[(0,n.jsxs)("div",{className:"p-6 border-b border-slate-100 flex items-start justify-between gap-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"text-lg font-bold text-slate-800",children:"Chọn th\xe1ng để đồng bộ"}),(0,n.jsx)("div",{className:"text-sm text-slate-500 mt-1",children:ep||"Chọn 1 hoặc nhiều th\xe1ng để đồng bộ lại điểm từ Google Sheet."})]}),(0,n.jsx)("button",{onClick:()=>ed(!1),className:"p-2 rounded-xl hover:bg-slate-100 text-slate-500",title:"Đ\xf3ng",type:"button",children:(0,n.jsx)(I.A,{size:20})})]}),(0,n.jsxs)("div",{className:"p-6 space-y-4",children:[(0,n.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[(0,n.jsxs)("div",{className:"flex-1 relative",children:[(0,n.jsx)(F.A,{className:"absolute left-3 top-2.5 text-slate-400",size:18}),(0,n.jsx)("input",{value:eu,onChange:e=>eg(e.target.value),placeholder:"T\xecm th\xe1ng (vd: 2025-10)...",className:"w-full pl-10 pr-3 py-2.5 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none text-sm"})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("button",{onClick:()=>em(new Set(ec)),className:"px-3 py-2 text-sm font-semibold rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700",type:"button",children:"Chọn tất cả"}),(0,n.jsx)("button",{onClick:()=>em(new Set),className:"px-3 py-2 text-sm font-semibold rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700",type:"button",children:"Bỏ chọn"})]})]}),(0,n.jsxs)("div",{className:"flex flex-wrap gap-2",children:[Array.from(eh).sort().slice(0,12).map(e=>(0,n.jsxs)("button",{type:"button",onClick:()=>ez(e),className:"inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-bold bg-emerald-50 text-emerald-700 border border-emerald-100 hover:bg-emerald-100",title:"Bỏ chọn",children:[e,(0,n.jsx)(I.A,{size:14})]},e)),eh.size>12&&(0,n.jsxs)("span",{className:"text-xs text-slate-500 px-2 py-1.5",children:["+",eh.size-12," th\xe1ng nữa"]})]}),(0,n.jsx)("div",{className:"border border-slate-200 rounded-2xl overflow-hidden",children:(0,n.jsx)("div",{className:"max-h-[320px] overflow-y-auto p-3 bg-slate-50",children:(0,n.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:eL.map(e=>{let t=eh.has(e);return(0,n.jsxs)("button",{type:"button",onClick:()=>ez(e),className:"flex items-center justify-between px-3 py-2 rounded-xl border text-sm font-semibold transition-all ".concat(t?"bg-white border-emerald-200 text-emerald-700 shadow-sm":"bg-white/70 border-slate-200 text-slate-700 hover:bg-white"),children:[(0,n.jsx)("span",{children:e}),(0,n.jsx)("span",{className:"w-5 h-5 rounded-md border flex items-center justify-center ".concat(t?"bg-emerald-600 border-emerald-600":"bg-white border-slate-300"),children:t&&(0,n.jsx)(c.A,{size:14,className:"text-white"})})]},e)})})})}),(0,n.jsxs)("div",{className:"text-xs text-slate-500",children:["Đ\xe3 chọn: ",(0,n.jsx)("span",{className:"font-bold text-slate-700",children:eh.size})," / ",ec.length," th\xe1ng"]})]}),(0,n.jsxs)("div",{className:"p-6 border-t border-slate-100 flex justify-end gap-2 bg-white",children:[(0,n.jsx)("button",{type:"button",onClick:()=>ed(!1),className:"px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold",children:"Hủy"}),(0,n.jsxs)("button",{type:"button",onClick:eE,disabled:es,className:"px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-2",children:[es?(0,n.jsx)(o.A,{size:18,className:"animate-spin"}):(0,n.jsx)(J.A,{size:18}),"Đồng bộ th\xe1ng đ\xe3 chọn"]})]})]})}),(0,n.jsxs)("header",{className:"bg-white/90 backdrop-blur-sm border-b border-slate-200/60 px-8 py-5 flex justify-between items-center sticky top-0 z-20 shadow-sm",children:[(0,n.jsxs)("div",{className:"flex items-center gap-4",children:[(0,n.jsx)("div",{className:"bg-indigo-600 p-2.5 rounded-xl text-white shadow-lg shadow-indigo-600/30",children:(0,n.jsx)(G.A,{size:22})}),(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold text-slate-800 tracking-tight",children:"Quản l\xfd Học tập"}),T&&C&&(0,n.jsxs)("span",{className:"ml-3 inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-emerald-50 text-emerald-700 border border-emerald-100",children:["Lớp phụ tr\xe1ch: ",C]})]})]}),(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsxs)("div",{className:"relative hidden md:block mr-2",children:[(0,n.jsx)(F.A,{className:"absolute left-3 top-2.5 text-slate-400",size:18}),(0,n.jsx)("input",{type:"text",placeholder:"T\xecm học sinh...",value:g,onChange:e=>p(e.target.value),className:"pl-10 pr-4 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all w-64 text-sm"})]}),(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsxs)("select",{className:"pl-3 pr-8 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white outline-none text-sm appearance-none cursor-pointer",value:y,onChange:e=>N(e.target.value),children:[(0,n.jsx)("option",{value:"ALL",children:"Tất cả lớp"}),ef.map(e=>(0,n.jsx)("option",{value:e,children:e},e))]}),(0,n.jsx)("div",{className:"absolute right-3 top-2.5 pointer-events-none text-slate-400",children:(0,n.jsx)("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,n.jsx)("polyline",{points:"6 9 12 15 18 9"})})})]}),!T&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("button",{onClick:eD,disabled:!!M,className:"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white text-sm font-semibold rounded-xl transition-all shadow-md hover:shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed",type:"button",children:[(0,n.jsx)(U.A,{size:18}),"AI H\xe0ng loạt"]}),(0,n.jsxs)("button",{onClick:eM,disabled:es||!!M,className:"flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold rounded-xl transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed",title:"Đồng bộ dữ liệu từ Google Sheet (Admin)",type:"button",children:[es?(0,n.jsx)(o.A,{className:"animate-spin",size:18}):(0,n.jsx)(J.A,{size:18}),"Đồng bộ Sheet"]}),(0,n.jsxs)("label",{className:"flex items-center gap-2 px-5 py-2 bg-slate-800 hover:bg-slate-900 text-white text-sm font-semibold rounded-xl cursor-pointer transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5",children:[(0,n.jsx)(J.A,{size:18}),"Nhập Excel",(0,n.jsx)("input",{type:"file",accept:".xlsx,.xls",className:"hidden",onChange:eT})]})]}),(0,n.jsx)(W,{}),(0,n.jsx)("button",{onClick:r,className:"text-sm font-semibold text-slate-500 hover:text-red-500 transition-colors px-2 ml-2",type:"button",children:"Đăng xuất"})]})]}),(0,n.jsx)("main",{className:"flex-1 p-8 max-w-[1400px] mx-auto w-full",children:(0,n.jsx)("div",{className:"bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 overflow-hidden",children:(0,n.jsx)("div",{className:"overflow-x-auto",children:(0,n.jsxs)("table",{className:"w-full text-left border-collapse",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{className:"bg-slate-50/50 border-b border-slate-200 text-xs uppercase text-slate-500 font-bold tracking-wider",children:[(0,n.jsx)("th",{className:"px-6 py-5 w-10",children:(0,n.jsx)("input",{type:"checkbox",disabled:T,checked:!T&&ev.length>0&&ev.every(e=>v.has(e.mhs)),onChange:e=>{T||(e.target.checked?j(new Set(ev.map(e=>e.mhs))):j(new Set))},title:T?"Gi\xe1o vi\xean kh\xf4ng d\xf9ng chọn h\xe0ng loạt":"Chọn/Bỏ chọn tất cả học sinh đang hiển thị"})}),(0,n.jsx)("th",{className:"px-6 py-5",children:"MHS"}),(0,n.jsx)("th",{className:"px-6 py-5 w-[90px] text-center",children:"MK"}),(0,n.jsx)("th",{className:"px-6 py-5",children:"Họ v\xe0 T\xean"}),(0,n.jsx)("th",{className:"px-6 py-5",children:"Lớp"}),(0,n.jsx)("th",{className:"px-6 py-5",children:"Điểm TB (Gần nhất)"}),(0,n.jsx)("th",{className:"px-6 py-5",children:"Rủi ro"}),(0,n.jsx)("th",{className:"px-6 py-5 cursor-pointer hover:bg-slate-100 transition-colors group select-none",onClick:()=>k(e=>"desc"===e?"asc":"asc"===e?"none":"desc"),children:(0,n.jsxs)("div",{className:"flex items-center gap-2",children:["Tiến độ Tick","desc"===w&&(0,n.jsx)("span",{className:"text-indigo-600",children:"↓"}),"asc"===w&&(0,n.jsx)("span",{className:"text-indigo-600",children:"↑"}),"none"===w&&(0,n.jsx)("span",{className:"text-slate-300 group-hover:text-slate-400",children:"↕"})]})}),(0,n.jsx)("th",{className:"px-6 py-5 text-right",children:"H\xe0nh động"})]})}),(0,n.jsx)("tbody",{className:"divide-y divide-slate-100",children:0===ev.length?(0,n.jsx)("tr",{children:(0,n.jsx)("td",{colSpan:9,className:"px-6 py-10 text-center text-slate-400 italic",children:T?"Chưa c\xf3 học sinh trong lớp phụ tr\xe1ch.":"Kh\xf4ng t\xecm thấy học sinh n\xe0o. H\xe3y nhập Excel hoặc Đồng bộ Sheet."})}):ev.map(e=>{var t,s;let a=null==(t=e.scores)?void 0:t[e.scores.length-1],l=[null==a?void 0:a.math,null==a?void 0:a.lit,null==a?void 0:a.eng].filter(e=>null!=e),r=l.length>0?(l.reduce((e,t)=>e+t,0)/l.length).toFixed(1):"N/A",i=ea(e),c=er(e),x=Array.isArray(null==e||null==(s=e.actionsByMonth)?void 0:s[i])?e.actionsByMonth[i]:Array.isArray(null==c?void 0:c[i])?c[i]:Array.isArray(e.activeActions)?e.activeActions:[],h=x.reduce((e,t)=>e+(Array.isArray(null==t?void 0:t.ticks)?t.ticks:[]).filter(e=>(null==e?void 0:e.completed)&&String((null==e?void 0:e.date)||"").slice(0,7)===i).length,0);return(0,n.jsxs)("tr",{className:"hover:bg-indigo-50/30 transition-colors duration-200 group",children:[(0,n.jsx)("td",{className:"px-6 py-4",children:(0,n.jsx)("input",{type:"checkbox",disabled:T,checked:!T&&v.has(e.mhs),onChange:t=>{T||j(s=>{let n=new Set(s);return t.target.checked?n.add(e.mhs):n.delete(e.mhs),n})}})}),(0,n.jsx)("td",{className:"px-6 py-4 text-sm font-mono text-slate-500 bg-transparent",children:e.mhs}),(0,n.jsx)("td",{className:"px-6 py-4 text-center",children:(0,n.jsx)(_,{mhs:e.mhs})}),(0,n.jsx)("td",{className:"px-6 py-4 text-sm font-semibold text-slate-800",children:e.name}),(0,n.jsx)("td",{className:"px-6 py-4 text-sm text-slate-600",children:e.class}),(0,n.jsxs)("td",{className:"px-6 py-4 text-sm text-slate-600",children:[(0,n.jsx)("span",{className:"px-2.5 py-1 rounded-lg font-bold text-xs ".concat("N/A"===r?"bg-slate-100 text-slate-500":Number(r)>=8?"bg-emerald-100 text-emerald-700":Number(r)>=5?"bg-amber-100 text-amber-700":"bg-rose-100 text-rose-700"),children:r}),a&&(0,n.jsxs)("span",{className:"text-[10px] text-slate-400 ml-2",children:["(",a.month,")"]})]}),(0,n.jsx)("td",{className:"px-6 py-4",children:e.aiReport?(0,n.jsxs)("span",{className:"inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide border ".concat("Cao"===e.aiReport.riskLevel?"bg-red-50 text-red-600 border-red-100":"Trung b\xecnh"===e.aiReport.riskLevel?"bg-orange-50 text-orange-600 border-orange-100":"bg-emerald-50 text-emerald-600 border-emerald-100"),children:["Cao"===e.aiReport.riskLevel&&(0,n.jsx)(X.A,{size:12}),e.aiReport.riskLevel]}):(0,n.jsx)("span",{className:"text-slate-300 text-xs italic",children:"--"})}),(0,n.jsx)("td",{className:"px-6 py-4 text-sm text-slate-600",children:x.length>0?(0,n.jsx)("div",{className:"w-full bg-slate-100 rounded-full h-2 max-w-[100px]",title:"".concat(h," tick ho\xe0n th\xe0nh • th\xe1ng nhiệm vụ ").concat(i),children:(0,n.jsx)("div",{className:"bg-indigo-500 h-2 rounded-full transition-all duration-500",style:{width:"".concat(Math.min(5*h,100),"%")}})}):(0,n.jsx)("span",{className:"text-slate-400",children:"-"})}),(0,n.jsx)("td",{className:"px-6 py-4 text-right",children:(0,n.jsxs)("div",{className:"flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[d===e.mhs?(0,n.jsx)("button",{disabled:!0,className:"px-4 py-2 bg-indigo-50 text-indigo-600 rounded-xl text-xs font-bold flex items-center gap-2",type:"button",children:(0,n.jsx)(o.A,{size:14,className:"animate-spin"})}):(0,n.jsx)("button",{onClick:()=>eC(e),className:"px-4 py-2 bg-white border border-indigo-200 hover:bg-indigo-600 hover:text-white hover:border-indigo-600 text-indigo-600 rounded-xl text-xs font-bold transition-all shadow-sm hover:shadow-md",type:"button",children:e.aiReport?"Tạo lại":"Tạo"}),(0,n.jsx)("button",{onClick:()=>{u(e.mhs),f("report")},className:"p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all",title:"Xem chi tiết",type:"button",children:(0,n.jsx)(V.A,{size:20})})]})})]},e.mhs)})})]})})})}),B&&(0,n.jsx)("div",{className:"fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity duration-300",children:(0,n.jsxs)("div",{className:"bg-white rounded-3xl w-full max-w-3xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col",children:[(0,n.jsxs)("div",{className:"flex justify-between items-center p-6 border-b border-slate-100 bg-white z-10",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h2",{className:"text-xl font-bold text-slate-800",children:B.name}),(0,n.jsxs)("p",{className:"text-sm text-slate-500 mt-1",children:["MHS: ",(0,n.jsx)("span",{className:"font-mono text-indigo-600",children:B.mhs})," | Lớp: ",B.class]})]}),(0,n.jsx)("button",{onClick:()=>u(null),className:"p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors",type:"button",children:(0,n.jsx)(I.A,{size:24})})]}),(0,n.jsxs)("div",{className:"flex border-b border-slate-100 px-6",children:[(0,n.jsx)("button",{onClick:()=>f("report"),className:"py-3 px-4 text-sm font-semibold border-b-2 transition-colors ".concat("report"===b?"border-indigo-600 text-indigo-600":"border-transparent text-slate-500 hover:text-slate-700"),type:"button",children:(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)($.A,{size:16})," B\xe1o c\xe1o AI"]})}),(0,n.jsx)("button",{onClick:()=>f("tracking"),className:"py-3 px-4 text-sm font-semibold border-b-2 transition-colors ".concat("tracking"===b?"border-indigo-600 text-indigo-600":"border-transparent text-slate-500 hover:text-slate-700"),type:"button",children:(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(x.A,{size:16})," Theo d\xf5i Th\xf3i quen"]})})]}),(0,n.jsxs)("div",{className:"p-8 space-y-6 overflow-y-auto custom-scrollbar bg-[#fcfcfc] flex-1",children:["report"===b&&(B.aiReport?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"flex justify-end mb-2",children:z?(0,n.jsxs)("button",{onClick:eR,className:"flex items-center gap-2 px-3 py-1.5 bg-emerald-500 text-white rounded-lg text-xs font-semibold hover:bg-emerald-600 shadow-md transition-all",type:"button",children:[(0,n.jsx)(Y.A,{size:14})," Lưu"]}):(0,n.jsxs)("button",{onClick:()=>E(!0),className:"flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-xs font-semibold hover:bg-slate-200 transition-colors",type:"button",children:[(0,n.jsx)(Q.A,{size:14})," Sửa nội dung"]})}),(0,n.jsxs)("div",{className:"p-5 rounded-2xl border ".concat("Cao"===B.aiReport.riskLevel?"border-red-200 bg-red-50/50":"Trung b\xecnh"===B.aiReport.riskLevel?"border-orange-200 bg-orange-50/50":"border-emerald-200 bg-emerald-50/50"),children:[(0,n.jsx)("h3",{className:"font-bold text-sm uppercase tracking-wide mb-3 ".concat("Cao"===B.aiReport.riskLevel?"text-red-700":"Trung b\xecnh"===B.aiReport.riskLevel?"text-orange-700":"text-emerald-700"),children:"Đ\xe1nh gi\xe1 Tổng quan"}),z?(0,n.jsx)("textarea",{className:"w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 bg-white",rows:3,value:R.overview,onChange:e=>O({...R,overview:e.target.value})}):(0,n.jsx)("p",{className:"text-sm text-slate-800 leading-relaxed",children:B.aiReport.overview})]}),(0,n.jsxs)("div",{className:"bg-indigo-50/50 p-5 rounded-2xl border border-indigo-100",children:[(0,n.jsx)("h3",{className:"font-bold text-sm uppercase tracking-wide text-indigo-700 mb-3",children:"Lời nhắn cho Học sinh"}),z?(0,n.jsx)("textarea",{className:"w-full p-3 border border-indigo-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 bg-white",rows:3,value:R.messageToStudent,onChange:e=>O({...R,messageToStudent:e.target.value})}):(0,n.jsxs)("p",{className:"text-sm text-indigo-900 italic",children:['"',B.aiReport.messageToStudent,'"']})]}),(0,n.jsxs)("div",{className:"bg-white p-5 rounded-2xl border border-slate-200 shadow-sm",children:[(0,n.jsxs)("h3",{className:"font-bold text-sm uppercase tracking-wide text-slate-600 mb-3 flex items-center gap-2",children:[(0,n.jsx)("span",{className:"w-2 h-2 rounded-full bg-slate-400"}),"Ghi ch\xfa Ri\xeang tư (GV)"]}),z?(0,n.jsx)("textarea",{className:"w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 bg-slate-50",rows:3,value:R.teacherNotes,onChange:e=>O({...R,teacherNotes:e.target.value})}):(0,n.jsx)("p",{className:"text-sm text-slate-600",children:B.aiReport.teacherNotes})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"font-bold text-sm uppercase tracking-wide text-slate-600 mb-3 ml-1",children:"Kế hoạch Học tập"}),(0,n.jsx)("div",{className:"text-sm text-slate-600 bg-white border border-slate-100 rounded-2xl shadow-sm divide-y divide-slate-50",children:B.aiReport.studyPlan.map((e,t)=>(0,n.jsxs)("div",{className:"p-4 grid grid-cols-4 gap-4",children:[(0,n.jsx)("span",{className:"font-bold text-slate-400 text-xs uppercase pt-1",children:e.day}),(0,n.jsx)("span",{className:"text-indigo-600 font-semibold",children:e.subject}),(0,n.jsx)("span",{className:"col-span-2 text-slate-700",children:e.content})]},t))})]})]}):(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center py-12 text-slate-400",children:[(0,n.jsx)(Z.A,{size:48,className:"mb-4 opacity-50"}),(0,n.jsx)("p",{children:'Chưa c\xf3 b\xe1o c\xe1o AI. H\xe3y nhấn n\xfat "Tạo" ở m\xe0n h\xecnh ch\xednh.'})]})),"tracking"===b&&(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6",children:[(0,n.jsx)("h3",{className:"font-bold text-slate-800",children:eA}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsxs)("div",{className:"flex items-center gap-1 bg-white border border-slate-200 rounded-xl p-1 shadow-sm",children:[(0,n.jsx)("button",{type:"button",onClick:()=>q("7"),className:"px-3 py-1.5 text-xs font-bold rounded-lg ".concat("7"===P?"bg-indigo-600 text-white":"text-slate-600 hover:bg-slate-100"),children:"7 ng\xe0y"}),(0,n.jsx)("button",{type:"button",onClick:()=>q("30"),className:"px-3 py-1.5 text-xs font-bold rounded-lg ".concat("30"===P?"bg-indigo-600 text-white":"text-slate-600 hover:bg-slate-100"),children:"30 ng\xe0y"}),(0,n.jsx)("button",{type:"button",onClick:()=>q("90"),className:"px-3 py-1.5 text-xs font-bold rounded-lg ".concat("90"===P?"bg-indigo-600 text-white":"text-slate-600 hover:bg-slate-100"),children:"90 ng\xe0y"}),(0,n.jsx)("button",{type:"button",onClick:()=>q("month"),className:"px-3 py-1.5 text-xs font-bold rounded-lg ".concat("month"===P?"bg-indigo-600 text-white":"text-slate-600 hover:bg-slate-100"),children:"Theo th\xe1ng"})]}),"month"===P&&(0,n.jsx)("select",{value:H,onChange:e=>K(e.target.value),className:"ml-1 px-3 py-2 text-sm rounded-xl border border-slate-200 bg-white shadow-sm outline-none",children:ey.slice().sort().reverse().map(e=>(0,n.jsx)("option",{value:e,children:e},e))})]})]}),0===eS.length?(0,n.jsx)("div",{className:"text-center py-10 text-slate-500 italic bg-slate-50 rounded-xl border border-dashed border-slate-200",children:"Th\xe1ng n\xe0y chưa c\xf3 nhiệm vụ n\xe0o (hoặc học sinh chưa được giao th\xf3i quen)."}):(0,n.jsx)("div",{className:"space-y-6",children:eS.map(e=>{let t=function(e){let t=new Map;return((null==e?void 0:e.ticks)||[]).forEach(e=>t.set(String(null==e?void 0:e.date),!!(null==e?void 0:e.completed))),t}(e),s=ek.reduce((e,s)=>e+ +!!t.get(s),0);return(0,n.jsxs)("div",{className:"bg-white border border-slate-100 rounded-2xl p-5 shadow-sm",children:[(0,n.jsxs)("div",{className:"flex justify-between items-start mb-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h4",{className:"font-semibold text-slate-700",children:e.description}),(0,n.jsx)("span",{className:"text-xs font-medium text-slate-400 bg-slate-100 px-2 py-0.5 rounded mt-1 inline-block",children:e.frequency})]}),(0,n.jsxs)("div",{className:"text-right",children:[(0,n.jsx)("span",{className:"text-2xl font-bold text-indigo-600",children:s}),(0,n.jsx)("p",{className:"text-[10px] text-slate-400 uppercase tracking-wide font-bold",children:"Tick (trong kỳ)"})]})]}),(0,n.jsx)("div",{className:"overflow-x-auto",children:(0,n.jsx)("div",{className:"min-w-[700px] flex items-center justify-between gap-2",children:ek.map(e=>{let s=!!t.get(e),a=new Date(e),l="".concat(a.getDate(),"/").concat(a.getMonth()+1);return(0,n.jsxs)("div",{className:"flex flex-col items-center gap-2 flex-1",children:[(0,n.jsx)("div",{className:"w-full h-2 rounded-full transition-all duration-500 ".concat(s?"bg-emerald-500":"bg-slate-100")}),(0,n.jsx)("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center text-xs font-medium transition-all ".concat(s?"bg-emerald-100 text-emerald-700":"bg-slate-50 text-slate-400 border border-slate-100"),title:e,children:s?(0,n.jsx)(c.A,{size:16}):(0,n.jsx)("span",{className:"text-[10px]",children:l})})]},e)})})})]},e.id)})})]})]})]})})]})};function ed(e){let{onLogin:t}=e,[s,l]=(0,a.useState)(""),[r,i]=(0,a.useState)(""),[o,d]=(0,a.useState)(null),[c,x]=(0,a.useState)(!1),h=async e=>{e.preventDefault(),d(null),x(!0);try{await t(s,r)}catch(e){d((null==e?void 0:e.message)||"Đăng nhập thất bại")}finally{x(!1)}};return(0,n.jsx)("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center p-6",children:(0,n.jsxs)("div",{className:"w-full max-w-md bg-white rounded-2xl shadow p-6",children:[(0,n.jsx)("div",{className:"text-xl font-bold text-slate-800",children:"Đăng nhập"}),(0,n.jsx)("div",{className:"text-sm text-slate-500 mt-1",children:" Gi\xe1o vi\xean / Học sinh"}),(0,n.jsxs)("form",{onSubmit:h,className:"mt-6 space-y-3",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"text-sm font-medium text-slate-700 mb-1",children:"T\xe0i khoản"}),(0,n.jsx)("input",{className:"w-full rounded-xl border border-slate-200 px-3 py-2 outline-none focus:ring-2 focus:ring-slate-200",value:s,onChange:e=>l(e.target.value),placeholder:"gv... / MHS",autoComplete:"username"})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"text-sm font-medium text-slate-700 mb-1",children:"Mật khẩu"}),(0,n.jsx)("input",{className:"w-full rounded-xl border border-slate-200 px-3 py-2 outline-none focus:ring-2 focus:ring-slate-200",value:r,onChange:e=>i(e.target.value),placeholder:"••••••••",type:"password",autoComplete:"current-password"})]}),o?(0,n.jsx)("div",{className:"text-sm text-red-600",children:o}):null,(0,n.jsx)("button",{disabled:c,className:"w-full rounded-xl bg-slate-900 text-white py-2 font-semibold hover:bg-slate-800 disabled:opacity-60",type:"submit",children:c?"Đang đăng nhập...":"Đăng nhập"})]})]})})}function ec(){let[e,t]=(0,a.useState)(null),[s,l]=(0,a.useState)(!0),[i,o]=(0,a.useState)([]),[d,c]=(0,a.useState)(null),x=(0,a.useMemo)(()=>e?"STUDENT"===e.role?"STUDENT":"TEACHER":"LOGIN",[e]);async function h(){l(!0);try{let e=await fetch("/api/me",{credentials:"include"}).then(e=>e.json());if((null==e?void 0:e.ok)&&(null==e?void 0:e.session)){let s={username:String(e.session.username||"admin"),name:e.session.name||"User",role:e.session.role};if(s.teacherClass=e.session.teacherClass,t(s),"STUDENT"===s.role){let e=await r.getStudentMe(s.username);c(e)}else{let e=await r.getAllStudents();o(e)}}else t(null),o([]),c(null)}catch(e){t(null),o([]),c(null)}finally{l(!1)}}(0,a.useEffect)(()=>{h()},[]);let m=async(e,s)=>{let n=await r.login(e,s);if(!n.success||!n.user)throw Error(n.error||"Đăng nhập thất bại");t(n.user),"STUDENT"===n.user.role?c(await r.getStudentMe(n.user.username)):o(await r.getAllStudents())},u=async()=>{try{await r.logout()}finally{t(null),o([]),c(null)}},g=async e=>{await r.importExcel(e),o(await r.getAllStudents())},p=async(e,t,s,n)=>{await r.saveReport(e,t,s,n),o(n=>n.map(n=>String(n.mhs).trim()!==String(e).trim()?n:{...n,aiReport:t,activeActions:s}))},b=async(t,s,n)=>{if(e&&"STUDENT"===e.role&&d){c(e=>e?function(e,t,s,n){let a=e=>(Array.isArray(e)?e:[]).map(e=>e&&e.id===t?{...e,ticks:function(e,t,s){let n=(Array.isArray(e)?[...e]:[]).filter(e=>String((null==e?void 0:e.date)||"")!==t);return s&&n.push({date:t,completed:!0}),n}(e.ticks,s,n)}:e),l={...e};if(l.activeActions=a(l.activeActions),l.actionsByMonth&&"object"==typeof l.actionsByMonth){let e={...l.actionsByMonth};for(let t of Object.keys(e))e[t]=a(e[t]);l.actionsByMonth=e}return l}(e,t,s,n):e);try{let a=await r.tick(e.username,t,s,n);if(null==a?void 0:a.student)c(a.student);else{let t=await r.getStudentMe(e.username);c(t)}}catch(t){c(await r.getStudentMe(e.username))}}};return s?(0,n.jsx)("div",{className:"p-6 text-slate-600",children:"Đang tải..."}):"LOGIN"===x?(0,n.jsx)(ed,{onLogin:m}):"STUDENT"===x?d?(0,n.jsx)(q,{student:d,onLogout:u,onUpdateAction:b}):(0,n.jsx)("div",{className:"p-6 text-slate-600",children:"Đang tải dữ liệu học sinh..."}):(0,n.jsx)(eo,{students:i,onImportData:g,onUpdateStudentReport:p,onLogout:u})}}},e=>{e.O(0,[364,441,255,358],()=>e(e.s=1389)),_N_E=e.O()}]);